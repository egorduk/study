{% extends "AcmeSecureBundle::layout.html.twig" %}

{% block title "View order" %}

    {% block content %}
        <link rel="stylesheet" href="{{ asset('bundles/css/jqgrid/custom-theme1/jquery-ui-1.10.3.custom.min.css') }}" />
        <link rel="stylesheet" href="{{ asset('bundles/css/jqgrid/ui.jqgrid.css') }}" />
        <link rel="stylesheet" href="{{ asset('bundles/css/datepicker.css') }}" />
        <link rel="stylesheet" href="{{ asset('bundles/css/datepicker3.css') }}" />
        <script type="text/javascript" src="{{ asset('bundles/js/jqgrid/i18n/grid.locale-ru.js') }}"></script>
        <script type="text/javascript" src="{{ asset('bundles/js/jqgrid/jquery.jqGrid.min.js') }}"></script>
        <script type="text/javascript" src="{{ asset('bundles/js/jqgrid/jquery.fmatter.js') }}"></script>
        <div class="container">
            <style type="text/css">
                .altRow {
                    background-color: #f3f3f3;
                    background-image: none;
                }
                .offset-margin-right {
                    float: right;
                    margin-right: -200px;
                }
                .ui-jqgrid .ui-jqgrid-htable th div {
                    height: 21px;
                }
                .gridCellTime {
                    color: blue;
                }
                .show-order, #dialog-configure-order {
                    display: none;
                }
                .label-primary {
                    background-color: #0088cc;
                }
                #ui-id-1 {
                    color: blue;
                }
                .input-group-addon {
                    cursor: pointer;
                }
                .icon-warning {
                    color: red;
                    font-size: 20px;
                    padding-right: 10px;
                }
                .bootstrap-focus {
                    border: 1px solid #66AFE9 !important;
                    box-shadow: 0 1px 1px rgba(0, 0, 0, 0.075) inset, 0 0 8px rgba(102, 175, 233, 0.6);
                    transition: border-color 0.15s ease-in-out 0s, box-shadow 0.15s ease-in-out 0s;
                    z-index: 2;
                }
                .bootstrap-blur {
                    border-color: #CCCCCC;
                    transition: border-color 0.15s ease-in-out 0s, box-shadow 0.15s ease-in-out 0s;
                }
                .bootstrap-error {
                    border-color: #E9322D!important;
                    box-shadow: 0 0 6px #E9322D!important;
                }
                /*body { font-size: 62.5%; }*/
                /*label, input { display:block; }*/
                input.text { margin-bottom:15px; width:100%; padding: .4em; }
                fieldset { padding:0; border:0; margin-top:15px; }
                h1 { font-size: 1.2em; margin: .6em 0; }
                .ui-dialog .ui-state-error { padding: .3em; }
                .validateTips { border: 1px solid transparent; padding: 0.3em; }
                textarea {
                    display: none;
                }
            </style>
            <div class="row offset-margin-right">
                <table id="listOrders"></table>
                <div id="pagerOrders"></div>
                <div id="dialog-configure-order" title="Управление заказом">
                    <p class="validateTips"></p>
                    <form>
                        <fieldset>
                            <label for="task">Задание</label>
                            <textarea name="task" id="task"></textarea>
                            <label for="new_date_expire">Выполнение до</label>
                            <div class="input-group">
                                <input type="text" name="new_date_expire" id="new_date_expire" required placeholder="Выберите дату..." value="" class="form-control">
                                <span class="input-group-addon"><i class="icon-calendar"></i></span>
                            </div>
                        </fieldset>
                    </form>
                </div>
                <script>
                    $(document).ready(function() {
                        $.fn.button.noConflict();
                        $("#listOrders").jqGrid({
                            url: {{ path('secure_client_orders', { type: 'view' }) | json_encode | raw }},
                            datatype: 'json',
                            mtype: 'POST',
                            recordtext: "Просмотр заказов {0} - {1}",
                            colNames:['','№ заказа','Тип работы', 'Тема работы', 'Предмет', 'Задание', 'Статус', 'Выполнение до', 'Ставки', 'Дата создания', 'Действия',''],
                            colModel :[
                                {name:'id',index:'id',key:true,search:false,hidden:true},
                                {name:'num',index:'num',width:100,align:'center',resizable:false,editable:false,searchrules:{"required":true, "number":true, "maxValue":13},searchoptions:{sopt:['eq','ne','bw','cn']},/*,formatter:'showlink',formatoptions:{baseLinkUrl:'someurl.php', addParam: '&action=edit'}*/},
                                {name:'type_order',index:'type_order',width:150,align:'center',resizable:false,editable:false, searchoptions:{sopt:['eq','ne','bw','cn']}},
                                {name:'theme',index:'theme',width:350,align:'center',resizable:false,editable:false, searchoptions:{sopt:['eq','bw','cn']}},
                                {name:'subject',index:'subject',width:170,align:'center',resizable:false, editable:false, searchoptions:{sopt:['eq','ne','bw','cn']}},
                                {name:'task',index:'task',width:250,align:'center',resizable:false, editable:false, searchoptions:{sopt:['eq','bw','cn']}},
                                {name:'status_order',index:'status_order',width:160,align:'center',resizable:false,editable:false,search:false},
                                {name:'date_expire',index:'date_expire',width:160,align:'center',resizable:false,editable:false,search:false},
                                {name:'response_author',index:'response_author',width:70,align:'center',resizable:false,editable:false,search:false,sortable:true},
                                {name:'date_create',index:'date_create',width:160,align:'center',resizable:false,editable:false,search:false},
                                {name:'action',width:120,align:'center',sortable:false,resize:false,formatter:function() {
                                    return "<div class='delete-order' style='margin-left:8px;'>" +
                                            "<div style='float:left;margin-left:5px;' class='ui-pg-div ui-inline-del' title='Удалить заказ' onmouseover=\"$(this).addClass('ui-state-hover');\" onmouseout=\"$(this).removeClass('ui-state-hover');\">" +
                                            "<span class='icon-trash'></span></div></div>" +
                                            "<div class='hide-order' style='margin-left:8px;'>" +
                                            "<div style='float:left;margin-left:5px;' class='ui-pg-div ui-inline-del' title='Скрыть заказ от авторов' onmouseover=\"$(this).addClass('ui-state-hover');\" onmouseout=\"$(this).removeClass('ui-state-hover');\">" +
                                            "<span class='icon-eye-off'></span></div></div>" +
                                            "<div class='show-order' style='margin-left:8px;'>" +
                                            "<div style='float:left;margin-left:5px;' class='ui-pg-div ui-inline-del' title='Показать заказ авторам' onmouseover=\"$(this).addClass('ui-state-hover');\" onmouseout=\"$(this).removeClass('ui-state-hover');\">" +
                                            "<span class='icon-eye'></span></div></div>" +
                                            "<div class='configure-order' style='margin-left:8px;'>" +
                                            "<div style='float:left;margin-left:5px;' class='ui-pg-div ui-inline-del' title='Изменить задание/срок' onmouseover=\"$(this).addClass('ui-state-hover');\" onmouseout=\"$(this).removeClass('ui-state-hover');\">" +
                                            "<span class='icon-cogs'></span></div></div>";
                                }},
                                {name:'is_show_author',index:'is_show_author',key:true,search:false,hidden:true}
                            ],
                            pager: $('#pagerOrders'),
                            toolbar: [true,'top'],
                            rowNum: 10,
                            rowList: [10,20,30],
                            viewrecords: true,
                            hidegrid: false,
                            caption: 'Таблица заказов',
                            height: '450',
                            altRows: true,
                            altclass:'altRow',
                            loadComplete : function() {
                                var grid  = $("#listOrders");
                                function getRowId(e) {
                                    var $td = $(e.target).closest('td'), $tr = $td.closest('tr.jqgrow'), rowId = $tr.attr('id');
                                    return rowId;
                                }
                                function getRow(a) {
                                    return a.parent().parent();
                                }
                                function actionHideOrder(a, type) {
                                    var blockShowOrder = a.find(".show-order"), blockHideOrder = a.find(".hide-order");
                                    if (type == "show") {
                                        blockShowOrder.hide();
                                        blockHideOrder.show();
                                    }
                                    else {
                                        blockShowOrder.show();
                                        blockHideOrder.hide();
                                    }
                                }
                                $(".delete-order").click(function(e) {
                                    var rowId = getRowId(e);
                                    if (rowId) {
                                        $.ajax({
                                            url: 'delete',
                                            type: 'POST',
                                            data: 'orderId=' + rowId,
                                            success: function(response) {
                                                var resposeObject = window.JSON.parse(response);
                                                if (resposeObject.action == "true") {
                                                    grid.trigger('reloadGrid');
                                                }
                                            }
                                        });
                                    }
                                });
                                $(".hide-order").click(function(e) {
                                    var rowId = getRowId(e);
                                    var row = getRow($(this));
                                    if (rowId) {
                                        $.ajax({
                                            url: 'hide',
                                            type: 'POST',
                                            data: 'orderId=' + rowId,
                                            success: function(response) {
                                                var resposeObject = window.JSON.parse(response);
                                                if (resposeObject.action == "true") {
                                                    //grid.trigger('reloadGrid');
                                                    grid.setCell(rowId,'status_order',"Скрытый");
                                                    actionHideOrder(row, "hide");
                                                }
                                            }
                                        });
                                    }
                                });
                                $(".show-order").click(function(e) {
                                    var rowId = getRowId(e);
                                    var row = getRow($(this));
                                    if (rowId) {
                                        $.ajax({
                                            url: 'show',
                                            type: 'POST',
                                            data: 'orderId=' + rowId,
                                            success: function(response) {
                                                var resposeObject = window.JSON.parse(response);
                                                if (resposeObject.action == "true") {
                                                    grid.trigger('reloadGrid');
                                                    actionHideOrder(row, "show");
                                                }
                                            }
                                        });
                                    }
                                });
                                $(".configure-order").click(function(e) {
                                    var rowId = getRowId(e);
                                    //var row = getRow($(this));
                                    var newDateExpire = $("#new_date_expire");
                                    if (rowId) {
                                        tinyMCE.init({
                                            mode : "textareas",
                                            width : 250,
                                            height : 250,
                                            language : 'ru',
                                            plugins : "preview",
                                            theme : "advanced",
                                            theme_advanced_buttons1 : "bold,italic,underline,strikethrough,removeformat,formatselect,forecolor,backcolor,link,unlink,undo,redo,preview,justifyleft,justifycenter,justifyright,bullist,numlist,pastetext",
                                            theme_advanced_buttons2 : "",
                                            theme_advanced_buttons3 : "",
                                            theme_advanced_toolbar_align : "left",
                                            relative_urls : false,
                                            setup : function(ed) {
                                                ed.onInit.add(function(ed) {
                                                    var mceLayout = $(".mceLayout");
                                                    mceLayout.css("border-radius", "2px");
                                                    mceLayout.css("border", "1px solid #CCCCCC");
                                                    ed.getDoc().addEventListener("click", function(){
                                                        setBootstrapStyle();
                                                        //ed.getBody().focus();
                                                        tinyMCE.activeEditor.focus();
                                                        newDateExpire.removeClass('bootstrap-focus')
                                                    });
                                                    ed.getDoc().addEventListener("blur", function(){
                                                        setDefaultStyleMce();
                                                        //ed.getBody().blur();
                                                        //newDateExpire.focus();
                                                    }, false);
                                                    //ed.getBody().focus();
                                                    tinyMCE.activeEditor.focus();
                                                    setBootstrapStyle();
                                                });
                                                ed.onClick.add(function(ed,e) {
                                                    newDateExpire.datepicker('hide');
                                                });
                                            }
                                        });
                                        $("#dialog-configure-order").dialog({
                                            resizable: false,
                                            autoclose: false,
                                            height: 530,
                                            width: 510,
                                            modal: true,
                                            buttons: {
                                                "Сохранить": function() {
                                                    var mceLayout = $(".mceLayout");
                                                    //mceLayout.removeClass('bootstrap-focus');
                                                    var tinyText = getTinyTrimText();
                                                    if (tinyText.length <= 0) {
                                                        mceLayout.addClass('bootstrap-error');
                                                        return false;
                                                    }
                                                    else {
                                                        var newTask = getTinyTextContent();
                                                        var newDateExpire = $("#new_date_expire").val();
                                                        $.ajax({
                                                            url: 'save_config',
                                                            type: 'POST',
                                                            data: 'orderId=' + rowId + '&newDateExpire=' + newDateExpire + '&newTask=' + newTask,
                                                            success: function(response) {
                                                                var responseObject = window.JSON.parse(response);
                                                                if (responseObject.action == "true") {
                                                                    mceLayout.removeClass('bootstrap-error');
                                                                    $("#dialog-configure-order").dialog("close");
                                                                    grid.trigger('reloadGrid');
                                                                }
                                                            }
                                                        });
                                                    }
                                                    //mceLayout.addClass('has-error');
                                                    /*var valid = true;
                                                    allFields.removeClass("ui-state-error");
                                                    valid = valid && checkTask(task, 4, 255);
                                                    valid = valid && checkNewDateExpire(new_date_expire);
                                                    if (valid) {
                                                        $(this).dialog("close");
                                                    }*/
                                                },
                                                "Отмена": function() {
                                                    $(this).dialog("close");
                                                    var tm = tinyMCE.get(0);
                                                    tm.setContent("");
                                                    newDateExpire.removeClass('bootstrap-focus');
                                                    $(".mceLayout").removeClass('bootstrap-error');
                                                }
                                            },
                                            close: function() {
                                                allFields.val("").removeClass("ui-state-error");
                                                tips.text("");
                                                tips.removeClass("ui-state-highlight");
                                                var tm = tinyMCE.get(0);
                                                tm.setContent("");
                                                newDateExpire.removeClass('bootstrap-focus');
                                                $(".mceLayout").removeClass('bootstrap-error');
                                            }
                                        });
                                        $.ajax({
                                            url: 'load_config',
                                            type: 'POST',
                                            data: 'orderId=' + rowId,
                                            success: function(response) {
                                                var responseObject = window.JSON.parse(response);
                                                if (responseObject.action == "true") {
                                                    var tm = tinyMCE.get(0);
                                                    tm.setContent(responseObject.task);
                                                    newDateExpire.datepicker('update', responseObject.dateExpire);
                                                    var today = new Date();
                                                    var dd = today.getDate() + 1;
                                                    var mm = today.getMonth() + 1;
                                                    var yyyy = today.getFullYear();
                                                    if(dd < 10) {
                                                        dd = '0' + dd
                                                    }
                                                    if(mm < 10) {
                                                        mm = '0' + mm
                                                    }
                                                    var currentDate = dd + '/' + mm + '/' + yyyy;
                                                    newDateExpire.datepicker('setStartDate', currentDate);
                                                    $("#dialog-configure-order").dialog();
                                                    var range = tinyMCE.DOM.createRng();
                                                    var newNode = tm.dom.select("p")[0];
                                                    range.setStart(newNode, 0);
                                                    range.setEnd(newNode, 1);
                                                    tm.selection.setRng(range);
                                                    tm.selection.collapse(false);
                                                }
                                            }
                                        });
                                        newDateExpire.datepicker({
                                            todayHighlight: true,
                                            format: "dd/mm/yyyy",
                                            autoclose: true,
                                            language: 'ru',
                                            todayBtn: true
                                        });
                                    }
                                });
                                var grids = grid.getDataIDs();
                                var gridsLength = grids.length;
                                for (var i = 0; i < gridsLength; i++) {
                                    var selectedRowOrder = $("tr.jqgrow#" + grids[i]);
                                    var blockShowOrder = selectedRowOrder.find(".show-order"), blockHideOrder = selectedRowOrder.find(".hide-order");
                                    if (Number(grid.getCell(grids[i], "is_show_author"))) {
                                        blockShowOrder.hide();
                                        blockHideOrder.show();
                                    }
                                    else {
                                        blockHideOrder.hide();
                                        blockShowOrder.show();
                                    }
                                }
                            },
                            onCellSelect: function(rowid, iCol) {
                                if (iCol != 10) {
                                    var rowData = grid.getRowData(rowid);
                                    var num = rowData['num'];
                                    location.href = 'view/' + num;
                                }
                            }
                        }).navGrid('#pagerOrders',{view:false, search:true, del:false, add:false, edit:false, refresh:true},
                                {},{},{},{closeOnEscape:true, multipleSearch:false, closeAfterSearch:true},{}
                        );

                        var task = $("#task"), newDateExpire = $("#new_date_expire"), allFields = $([]).add(task).add(newDateExpire), tips = $(".validateTips");
                        function updateTips(t) {
                            tips.html("<span class='icon-warning'></span>" + t).addClass("ui-state-highlight");
                        }
                        function checkTask(o, min, max) {
                            if (o.val().length > max || o.val().length < min) {
                                o.addClass("ui-state-error");
                                updateTips("Введено слишком короткое описание задания (" + min + " - " + max + " символа)");
                                return false;
                            }
                            else {
                                return true;
                            }
                        }
                        function checkNewDateExpire(o) {
                            if (o.val() == "") {
                                o.addClass("ui-state-error");
                                updateTips("Выберите, до какой даты выполняется заказ!");
                                return false;
                            }
                            else {
                                return true;
                            }
                        }
                        function getTinyTrimText() {
                            var tm = tinyMCE.get(0);
                            var tinyText = $(tm.getBody()).text();
                            tinyText = tinyText.trim();
                            return tinyText;
                        }
                        /*$("#dialog-configure-order").on("dialogopen", function(event, ui) {
                        });*/
                        function getTinyTextContent() {
                            var tm = tinyMCE.get(0);
                            var tinyTextContent = tm.getContent();
                            return tinyTextContent;
                        }
                        function setBootstrapStyle() {
                            $(".mceLayout").addClass('bootstrap-focus');

                        }
                        function setDefaultStyleMce() {
                            var mceLayout = $(".mceLayout");
                            mceLayout.removeClass('bootstrap-focus');
                            //mceLayout.addClass('bootstrap-blur');
                        }
                        newDateExpire.on("click", function() {
                            $(this).addClass('bootstrap-focus');
                            $(this).datepicker('show');
                        });

                        $(".input-group-addon").click(function(e){
                            newDateExpire.datepicker('show');
                            $(".mceLayout").removeClass('bootstrap-focus');
                            newDateExpire.addClass('bootstrap-focus');
                            /*var tm = tinyMCE.get(0);
                            var controlManager = tm.controlManager;
                            var elements = controlManager.controls;
                            console.log(tm);
                            tm.theme.toolbarGroup.disabled = 1;
                            $.each(elements, function(element) {
                                controlManager.setActive(element, false);
                            });*/
                        });

                        $("#t_listOrders").height(60);
                        $("#t_listOrders").append('<div id="">Для поиска нажмите на </div><div id="">Для сброса результата поиска нажмите на </div><div id="">Для обновления таблицы нажмите на </div>');
                        $(".default").addClass('form-control');

                        /*function closeMessage(el) {
                            el.addClass('is-hidden');
                        }
                        $('.js-messageClose').on('click', function(e) {
                            closeMessage($(this).closest('.Message'));
                        });
                        setTimeout(function() {
                            closeMessage($('#js-timer'));
                        }, 3000);*/
                    });
                </script>
            </div>
            <script type="text/javascript" src="{{ asset('bundles/js/bootstrap-datepicker.js') }}"></script>
            <script type="text/javascript" src="{{ asset('bundles/js/locales/bootstrap-datepicker.ru.js') }}"></script>
            <a href="{{ path('secure_client_index') }}">Главная</a>
        </div>
    {% endblock %}