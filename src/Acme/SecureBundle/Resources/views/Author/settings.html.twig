{% extends "AcmeSecureBundle::layout_author.html.twig" %}
{% block title "Настройки аккаунта" %}
    {% block content %}
        <link href="{{ asset('bundles/css/window.css') }}" rel="stylesheet" />
        <link href="{{ asset('bundles/css/select2.css') }}" rel="stylesheet" />
        <script type="text/javascript" src="{{ asset('bundles/js/bootstrap-maxlength.min.js') }}"></script>
        <script type="text/javascript" src="{{ asset('bundles/js/select2.min.js') }}"></script>
        <script type="text/javascript" src="{{ asset('bundles/js/price-format.js') }}"></script>
        <div class="body">
            <style>
                .table {
                    cursor: pointer;
                }
                #block-btn--change {
                    display: none;
                }
                .bigdrop.select2-container .select2-results {
                    max-height: 300px;
                }
                .bigdrop .select2-results {
                    max-height: 300px;
                }
            </style>
            {% if (showWindow) %}
                <div id="success-window">
                    <div class="Message Message--green" id="js-timer">
                        <div class="Message-icon">
                            <i class="fa fa-check"></i>
                        </div>
                        <div class="Message-body">
                            <p align="center">Ваши данные сохранены!</p>
                        </div>
                        <button class="Message-close js-messageClose"><i class="fa fa-times"></i></button>
                    </div>
                </div>
            {% endif %}
            <div class="row">
                <p>Мои кошельки:</p>
                <table class="table table-hover" id="table-user-ps">
                    <thead>
                    <tr>
                        <th>Система</th>
                        <th>Название кошелька</th>
                        <th>Номер кошелька</th>
                        <th>Действия</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for ps in userPs %}
                        <tr class="danger" data-id="{{ ps.id }}">
                            <td data-code="{{ ps.typeps.code }}">{{ ps.typeps.name }}</td>
                            <td>{{ ps.name }}</td>
                            <td>{{ ps.num }}</td>
                            <td>
                                <div style='float:left' data-title='Изменить' onmouseover="$(this).tooltip('show')" data-toggle='tooltip' data-placement='left'>
                                    <span data-id="{{ ps.id }}" class='icon-edit-3 edit-ps'></span>
                                </div>
                                <div style='float:left;margin-left:5px;' data-title='Удалить' onmouseover="$(this).tooltip('show')" data-toggle='tooltip' data-placement='left'>
                                    <span data-id="{{ ps.id }}" class='icon-trash-1 delete-ps'></span>
                                </div>
                                <div style='float:left;margin-left:5px;' data-title='Вывести деньги' onmouseover="$(this).tooltip('show')" data-toggle='tooltip' data-placement='left'>
                                    <span data-id="{{ ps.id }}" class='icon-money-2 output-ps'></span>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="row">
                <div class="col-xs-4 col-xs-offset-4">
                    {% form_theme formCreatePs "TwigBundle::layout.html.twig" %}
                    {{ form_start(formCreatePs) }}
                    {{ form_label(formCreatePs.fieldNum) }}
                    {{ form_errors(formCreatePs.fieldNum) }}
                    <div class="input-group">
                        <span class="input-group-addon"><i class="icon-fontsize-1"></i></span>
                        {{ form_widget(formCreatePs.fieldNum) }}
                    </div>
                    {{ form_label(formCreatePs.fieldName) }}
                    {{ form_errors(formCreatePs.fieldName) }}
                    <div class="input-group">
                        <span class="input-group-addon"><i class="icon-fontsize-1"></i></span>
                        {{ form_widget(formCreatePs.fieldName) }}
                    </div>
                    {{ form_label(formCreatePs.fieldType) }}
                    <div class="input-group">
                        {{ form_widget(formCreatePs.fieldType) }}
                    </div>
                    </br>
                    <div class="input-group">
                    <span id="block-btn--change">
                        <label for="formCreatePs_change" class="btn btn-success"><span class="icon-trash-1">&nbspИзменить</span></label>
                        {{ form_widget(formCreatePs.change) }}
                    </span>
                        <label for="formCreatePs_add" class="btn btn-success"><span class="icon-floppy"></span>&nbspДобавить</label>
                        {{ form_widget(formCreatePs.add) }}
                        <label for="formCreatePs_reset" class="btn btn-success"><span class="icon-trash-1">&nbspОчистить</span></label>
                        {{ form_widget(formCreatePs.reset) }}
                    </div>
                    {{ form_end(formCreatePs) }}
                </div>
            </div>
            <div class="row">
                <div class="col-xs-4 col-xs-offset-4">
                    {% form_theme formOutputPs "TwigBundle::layout.html.twig" %}
                    {{ form_start(formOutputPs, {'attr': {'id' : 'formOutputPs'}}) }}
                    {{ form_label(formOutputPs.fieldSum) }}
                    {{ form_errors(formOutputPs.fieldSum) }}
                    <div class="input-group">
                        <span class="input-group-addon"><i class="icon-fontsize-1"></i></span>
                        {{ form_widget(formOutputPs.fieldSum) }}
                    </div>
                    {{ form_label(formOutputPs.fieldComment) }}
                    {{ form_errors(formOutputPs.fieldComment) }}
                    <div class="input-group">
                        <span class="input-group-addon"><i class="icon-fontsize-1"></i></span>
                        {{ form_widget(formOutputPs.fieldComment) }}
                    </div>
                    {{ form_label(formOutputPs.fieldType) }}
                    <div class="input-group">
                        {{ form_widget(formOutputPs.fieldType) }}
                    </div>
                    </br>
                    <div class="input-group">
                        <label for="formOutputPs_output" class="btn btn-success"><span class="icon-floppy"></span>&nbspВывести</label>
                        {{ form_widget(formOutputPs.output) }}
                    </div>
                    {{ form_end(formOutputPs) }}
                </div>
            </div>
            <div class="row">
                {% form_theme formMailOptions "TwigBundle::layout.html.twig" %}
                {{ form_start(formMailOptions) }}
                {{ form_label(formMailOptions.fieldOptions) }}
                {{ form_errors(formMailOptions.fieldOptions) }}
                <div class="input-group">
                    {{ form_widget(formMailOptions.fieldOptions) }}
                </div>
                <br>
                <div class="input-group">
                    <label for="formMailOptions_save" class="btn btn-success"><span class="icon-floppy"></span>&nbspСохранить</label>
                    {{ form_widget(formMailOptions.save) }}
                </div>
                {{ form_end(formMailOptions) }}
            </div>
            <script>
                $(document).ready(function() {
                    function format(state) {
                        return "<img title='" + state.text + "' class='icon' src='{{ asset('bundles/images/ps/') }}" + state.id.toLowerCase() + ".png'/> " + state.text + "";
                    }
                    function repoFormat(state) {
                        var arr = state.text.split('|');
                        return arr[1];
                    }
                    function repoFormatResult(state) {
                        var arr = state.text.split('|');
                        console.log(arr);
                        var markup = '<div class="row-fluid">' +
                                '<div class="span10">' +
                                '<div class="row-fluid">' +
                                '<div class="span6">Номер:' + arr[1] + '</div>' +
                                '<div class="span3">Название:' + arr[0] + '</div>' +
                                '<div class="span3">Тип:<img src="{{ asset('bundles/images/ps/') }}' + arr[2] + '.png"/></div>' +
                                '</div></div></div>';
                        return markup;
                    }
                    function repoFormatSelection(repo) {
                        return repo.full_name;
                    }
                    $("#formCreatePs_fieldType").select2({
                        minimumResultsForSearch: -1,
                        formatResult: format,
                        formatSelection: format,
                        width: '170',
                        escapeMarkup: function(m) { return m; }
                    });
                    $("#formOutputPs_fieldType").select2({
                        minimumResultsForSearch: -1,
                        formatResult: repoFormatResult,
                        formatSelection: repoFormat,
                        allowClear: true,
                        width: 'element',
                        dropdownCssClass: "bigdrop",
                        escapeMarkup: function(m) { return m; }
                    });
                    $("#formMailOptions_fieldOptions").select2({
                        placeholder: "Выберите",
                        minimumResultsForSearch: -1,
                        width: 'element',
                        formatSearching: null,
                        formatNoMatches: null
                    }).on("select2-opening", function(e) {
                        var countElements = $(this).select2("val");
                        if (countElements.length >= 2) {
                            e.preventDefault();
                        }
                    });
                    $("#formCreatePs_reset").click(function() {
                        $("#formCreatePs_fieldType").select2("val", "wm");
                    });
                    $(".edit-ps").click(function() {
                        var psId = $(this).attr('data-id'), row = $(this).parents('tr'), allTd = row.find('td');
                        $("#formCreatePs_fieldNum").val(allTd.eq(2).text());
                        $("#formCreatePs_fieldName").val(allTd.eq(1).text());
                        var psCode = allTd.eq(0).attr('data-code');
                        $("#formCreatePs_fieldType").select2("val", psCode);
                        $("#block-btn--change").show();
                        $(".hidden-ps-id").val(psId);
                    });
                    $(".delete-ps").click(function() {
                        var psId = $(this).attr('data-id');
                        $.ajax({
                            type: 'POST',
                            data: 'psId=' + psId + '&mode=deletePs',
                            success: function(response) {
                                var responseObject = window.JSON.parse(response);
                                if (responseObject.response) {
                                    var trRemoved = $("#table-user-ps").find("tr[data-id='" + psId + "']").remove();
                                }
                            }
                        });
                    });
                    $(".output-ps").click(function() {
                        var psId = $(this).attr('data-id');
                        $.ajax({
                            type: 'POST',
                            data: 'psId=' + psId + '&mode=outputPs',
                            success: function(response) {
                                var responseObject = window.JSON.parse(response);
                                if (responseObject.response) {
                                    var trRemoved = $("#table-user-ps").find("tr[data-id='" + psId + "']").remove();
                                }
                            }
                        });
                    });
                    $("#formOutputPs_output").click(function() {
                        var formOutputPs = $("#formOutputPs");
                        $.ajax({
                            type: 'POST',
                            data: formOutputPs.serialize(),
                            success: function(response) {
                                var responseObject = window.JSON.parse(response);
                                $(".error, .block-error").remove();
                                if (responseObject.response) {
                                } else {
                                    $.each(responseObject.form, function(index, value) {
                                        var selector  = "#formOutputPs_" + index;
                                        $(selector).parent().before("<p class='block-error'><span class='icon-warning error'>" + value + "</span></p>");
                                    });
                                }
                            }
                        });
                    });
                    $("input[id^=formCreatePs_field], input[id^=formOutputPs_field]").maxlength({
                        alwaysShow: true
                    });
                    $('#formOutputPs_fieldSum').priceFormat({
                        prefix: '',
                        centsSeparator: '',
                        thousandsSeparator: ' ',
                        centsLimit: 0,
                        clearOnEmpty: true
                    });


                    function closeMessage(el) {
                        el.addClass('is-hidden');
                    }
                    $('.js-messageClose').on('click', function(e) {
                        closeMessage($(this).closest('.Message'));
                    });
                    setTimeout(function() {
                        closeMessage($('#js-timer'));
                    }, 1500);
                });
            </script>
        </div>
    {% endblock %}